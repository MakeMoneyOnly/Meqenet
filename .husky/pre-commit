# Meqenet.et Pre-Commit Hook
# Enterprise-Grade FinTech Security & Quality Gate

echo "ğŸš€ Meqenet.et Enterprise Pre-Commit Quality Checks"
echo "=================================================="

# Set NODE_OPTIONS to prevent memory issues and enable better performance
export NODE_OPTIONS="--max-old-space-size=4096 --enable-source-maps=false"
export LINT_STAGED_CONCURRENCY=2

# Get staged files count for better reporting
STAGED_COUNT=$(git diff --cached --name-only | wc -l)
echo "ğŸ“Š Staged files: $STAGED_COUNT"

# ============================================================================
# PHASE 1: BASIC QUALITY GATES
# ============================================================================

echo "ğŸ“ Phase 1: Running basic quality checks..."

# 1. Run lint-staged for staged files (formatting and linting)
echo "  â€¢ Code formatting and linting..."
if [ "$STAGED_COUNT" -gt 50 ]; then
  echo "  âš ï¸  Large commit detected ($STAGED_COUNT files). Using optimized processing..."
fi

pnpm exec lint-staged || {
  echo "âŒ Code quality checks failed"
  echo ""
  echo "ğŸ“‹ Issues found in staged files. Please fix the following:"
  echo "   â€¢ Run: pnpm eslint --fix <problematic-file>"
  echo "   â€¢ Run: pnpm prettier --write <problematic-file>"
  echo ""
  echo "ğŸš« Commit blocked. Fix issues and try again, or use --no-verify to bypass."
  exit 1
}

# ============================================================================
# PHASE 2: ENTERPRISE SECURITY VALIDATION
# ============================================================================

echo "ğŸ” Phase 2: Enterprise security validation..."

# 2. Secret Scanning - Critical for FinTech
echo "  â€¢ Scanning for hardcoded secrets..."
if ! timeout 30 pnpm run security:secrets 2>&1; then
  echo "âŒ SECRET SCANNING FAILED!"
  echo ""
  echo "ğŸš¨ CRITICAL: Potential hardcoded secrets detected!"
  echo "   â€¢ Check the output above for specific files and issues found"
  echo "   â€¢ Review and remove any hardcoded API keys, passwords, or tokens"
  echo "   â€¢ Use environment variables or secure vaults instead"
  echo ""
  echo "ğŸ”§ To bypass: git commit --no-verify"
  exit 1
fi

# 3. Dependency Security Scan
echo "  â€¢ Checking for vulnerable dependencies..."
if ! timeout 20 pnpm audit --audit-level high >/dev/null 2>&1; then
  echo "âš ï¸  DEPENDENCY VULNERABILITIES DETECTED!"
  echo "   â€¢ High or critical security vulnerabilities found"
  echo "   â€¢ Run 'pnpm audit' for detailed information"
  echo "   â€¢ Consider updating vulnerable packages immediately"
fi

# 4. License Compliance Check
echo "  â€¢ Validating license compliance..."
if ! timeout 15 pnpm run security:license-check >/dev/null 2>&1; then
  echo "âš ï¸  LICENSE COMPLIANCE ISSUES DETECTED!"
  echo "   â€¢ Incompatible or restricted licenses found"
  echo "   â€¢ Review reports/license-check.json for details"
fi

# 5. Financial Logic Validation
echo "  â€¢ Validating financial logic integrity..."
STAGED_FILES=$(git diff --cached --name-only)

# Check for financial/payment related files
FINANCIAL_FILES=$(echo "$STAGED_FILES" | grep -E "(payment|credit|bnpl|financial|auth|loan|interest|transaction|money|currency|wallet)" || true)
if [ -n "$FINANCIAL_FILES" ]; then
  echo "  â€¢ Financial code changes detected - validating critical patterns..."

  # Check for dangerous patterns in financial code
  DANGEROUS_PATTERNS=$(echo "$FINANCIAL_FILES" | xargs grep -l "eval(\|new Function\|setTimeout.*eval\|setInterval.*eval\|Function.*constructor\|global\[" 2>/dev/null || true)
  if [ -n "$DANGEROUS_PATTERNS" ]; then
    echo "âŒ CRITICAL: Dangerous code patterns detected in financial logic!"
    echo "   â€¢ Files with risky patterns: $DANGEROUS_PATTERNS"
    echo "   â€¢ eval(), dynamic code execution, or global object manipulation found"
    echo "   â€¢ This poses severe security risks in financial systems"
    echo "   â€¢ Replace with secure alternatives or remove if unnecessary"
    exit 1
  fi

  # Check for SQL injection patterns in financial code
  SQL_INJECTION=$(echo "$FINANCIAL_FILES" | xargs grep -l "sql.*+\|query.*+\|\$\{.*\}.*SELECT\|\$\{.*\}.*INSERT\|\$\{.*\}.*UPDATE\|\$\{.*\}.*DELETE" 2>/dev/null || true)
  if [ -n "$SQL_INJECTION" ]; then
    echo "âš ï¸  WARNING: Potential SQL injection patterns detected in financial code"
    echo "   â€¢ Files: $SQL_INJECTION"
    echo "   â€¢ Use parameterized queries or ORM methods instead"
    echo "   â€¢ Review for proper input sanitization"
  fi

  # Check for proper error handling in financial code
  NO_ERROR_HANDLING=$(echo "$FINANCIAL_FILES" | xargs grep -L "try.*catch\|throw.*Error\|reject.*Error\|catch.*error\|handleError" 2>/dev/null | grep -v ".test." | grep -v ".spec." | grep -v ".mock." || true)
  if [ -n "$NO_ERROR_HANDLING" ]; then
    echo "âš ï¸  WARNING: Financial code without comprehensive error handling detected"
    echo "   â€¢ Files missing error handling: $(echo "$NO_ERROR_HANDLING" | wc -l) files"
    echo "   â€¢ Financial operations must have robust error handling"
    echo "   â€¢ Consider adding try-catch blocks, proper logging, and error recovery"
  fi
fi

# ============================================================================
# PHASE 3: COMPLIANCE & REGULATORY CHECKS
# ============================================================================

echo "ğŸ“‹ Phase 3: Compliance and regulatory checks..."

# 6. NBE Compliance Validation
echo "  â€¢ NBE (Ethiopian Banking) compliance validation..."
if [ -n "$FINANCIAL_FILES" ]; then
  # Check for required compliance patterns
  COMPLIANCE_MISSING=$(echo "$FINANCIAL_FILES" | xargs grep -L "audit\|compliance\|NBE\|regulatory\|AML\|KYC" 2>/dev/null | grep -v ".test." | grep -v ".spec." || true)
  if [ -n "$COMPLIANCE_MISSING" ]; then
    echo "âš ï¸  WARNING: Financial changes without explicit compliance documentation"
    echo "   â€¢ Files missing compliance markers: $(echo "$COMPLIANCE_MISSING" | wc -l) files"
    echo "   â€¢ NBE requires audit trails for all financial transactions"
    echo "   â€¢ Consider adding compliance comments or audit logging"
    echo "   â€¢ Required tags: @audit, @compliance, @nbe, @regulatory, @aml, @kyc"
  fi
fi

# 7. GDPR Compliance Check
echo "  â€¢ GDPR compliance validation..."
PERSONAL_DATA_FILES=$(echo "$STAGED_FILES" | grep -E "(user|customer|personal|profile|auth|account|identity|contact|email|phone|address)" || true)
if [ -n "$PERSONAL_DATA_FILES" ]; then
  GDPR_MISSING=$(echo "$PERSONAL_DATA_FILES" | xargs grep -L "consent\|privacy\|gdpr\|data.*protection\|pii\|personal.*data" 2>/dev/null | grep -v ".test." | grep -v ".spec." || true)
  if [ -n "$GDPR_MISSING" ]; then
    echo "âš ï¸  WARNING: Personal data handling without GDPR compliance markers"
    echo "   â€¢ Files missing GDPR markers: $(echo "$GDPR_MISSING" | wc -l) files"
    echo "   â€¢ User data changes require GDPR compliance documentation"
    echo "   â€¢ Ensure proper consent mechanisms and data protection"
    echo "   â€¢ Required: Data retention policies, consent management, PII classification"
  fi
fi

# 8. Accessibility Compliance Check
echo "  â€¢ Accessibility compliance validation..."
UI_FILES=$(echo "$STAGED_FILES" | grep -E "\.(tsx|jsx|vue|svelte|html)$" || true)
if [ -n "$UI_FILES" ]; then
  ACCESSIBILITY_MISSING=$(echo "$UI_FILES" | xargs grep -L "aria-\|role=\|tabindex\|alt=\|accessibility\|a11y\|wcag" 2>/dev/null || true)
  if [ -n "$ACCESSIBILITY_MISSING" ]; then
    echo "â„¹ï¸  INFO: UI changes detected - consider accessibility compliance"
    echo "   â€¢ Files without accessibility markers: $(echo "$ACCESSIBILITY_MISSING" | wc -l) files"
    echo "   â€¢ WCAG 2.1 AA compliance recommended for Ethiopian market"
    echo "   â€¢ Consider adding ARIA labels, semantic HTML, and keyboard navigation"
  fi
fi

# ============================================================================
# PHASE 4: CODE QUALITY METRICS
# ============================================================================

echo "ğŸ“Š Phase 4: Code quality metrics..."

# 9. Complexity Analysis
echo "  â€¢ Analyzing code complexity..."
COMPLEX_FILES=$(echo "$STAGED_FILES" | grep -E "\.(ts|tsx|js|jsx)$" | head -10)
if [ -n "$COMPLEX_FILES" ]; then
  # Check for overly complex functions (lines of code heuristic)
  COMPLEX_FUNCTIONS=$(echo "$COMPLEX_FILES" | xargs wc -l | awk '$1 > 100 {print $2 ": " $1 " lines"}' || true)
  if [ -n "$COMPLEX_FUNCTIONS" ]; then
    echo "âš ï¸  WARNING: Large files detected (>100 lines)"
    echo "$COMPLEX_FUNCTIONS"
    echo "   â€¢ Consider breaking down large files for maintainability"
    echo "   â€¢ Large files are harder to review and maintain"
  fi

  # Check for nested complexity
  DEEP_NESTING=$(echo "$COMPLEX_FILES" | xargs grep -n "if.*if\|for.*for\|while.*while" | wc -l 2>/dev/null || echo "0")
  if [ "$DEEP_NESTING" -gt 5 ]; then
    echo "âš ï¸  WARNING: Deep nesting detected in multiple files"
    echo "   â€¢ Consider extracting nested logic into separate functions"
    echo "   â€¢ Deep nesting reduces code readability and maintainability"
  fi
fi

# 10. Dead Code Detection
echo "  â€¢ Checking for unused code..."
UNUSED_EXPORTS=$(echo "$STAGED_FILES" | xargs grep -l "export.*unused\|//.*TODO.*remove\|//.*FIXME.*remove" 2>/dev/null || true)
if [ -n "$UNUSED_EXPORTS" ]; then
  echo "â„¹ï¸  INFO: Potential dead code or TODO items detected"
  echo "   â€¢ Files with unused markers: $(echo "$UNUSED_EXPORTS" | wc -l) files"
  echo "   â€¢ Review and remove unused exports, dead code, and outdated TODOs"
fi

# ============================================================================
# PHASE 5: DEPENDENCY & SECURITY SCANNING
# ============================================================================

echo "ğŸ›¡ï¸  Phase 5: Dependency and security scanning..."

# 11. Dependency Vulnerability Check
echo "  â€¢ Checking for dependency vulnerabilities..."
if ! timeout 15 pnpm audit --audit-level moderate >/dev/null 2>&1; then
  echo "âš ï¸  WARNING: Dependency vulnerabilities detected"
  echo "   â€¢ Run 'pnpm audit' for detailed vulnerability information"
  echo "   â€¢ Consider updating vulnerable packages or applying security patches"
  echo "   â€¢ Critical vulnerabilities should be addressed immediately"
fi

# 12. Outdated Dependencies Check
echo "  â€¢ Checking for outdated dependencies..."
OUTDATED_COUNT=$(timeout 10 pnpm outdated --json 2>/dev/null | grep -c '"latest"' || echo "0")
if [ "$OUTDATED_COUNT" -gt 10 ]; then
  echo "â„¹ï¸  INFO: $OUTDATED_COUNT+ outdated dependencies detected"
  echo "   â€¢ Consider updating dependencies regularly"
  echo "   â€¢ Run 'pnpm update' to update non-breaking changes"
  echo "   â€¢ Major version updates should be tested thoroughly"
fi

# ============================================================================
# PHASE 6: FINAL VALIDATION
# ============================================================================

echo "ğŸ¯ Phase 6: Final validation..."

# 13. Commit Message Validation
echo "  â€¢ Validating commit message format..."
COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null || echo "")
if [ -n "$COMMIT_MSG" ]; then
  if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|security)(\(.+\))?: .+"; then
    echo "âš ï¸  WARNING: Commit message doesn't follow conventional format"
    echo "   â€¢ Use: type(scope): description"
    echo "   â€¢ Types: feat, fix, docs, style, refactor, perf, test, chore, build, ci, security"
    echo "   â€¢ Example: feat(auth): add biometric authentication"
    echo "   â€¢ Example: fix(payment): resolve transaction timeout issue"
  fi

  # Check for minimum description length
  MSG_LENGTH=$(echo "$COMMIT_MSG" | wc -c)
  if [ "$MSG_LENGTH" -lt 10 ]; then
    echo "âš ï¸  WARNING: Commit message is too short"
    echo "   â€¢ Provide more descriptive commit messages"
    echo "   â€¢ Explain what changed and why"
  fi
fi

# 14. File Size Validation
echo "  â€¢ Validating file sizes..."
LARGE_FILES=$(git diff --cached --name-only | xargs ls -lh 2>/dev/null | awk '$5 > 10485760 {print $9 ": " $5}' || true)
if [ -n "$LARGE_FILES" ]; then
  echo "âš ï¸  WARNING: Large files detected in commit"
  echo "$LARGE_FILES"
  echo "   â€¢ Files larger than 10MB may cause repository bloat"
  echo "   â€¢ Consider using Git LFS for large binary files"
  echo "   â€¢ Review if large files are necessary for the repository"
fi

# 15. Binary File Detection
echo "  â€¢ Checking for binary files..."
BINARY_FILES=$(git diff --cached --name-only | xargs file 2>/dev/null | grep -v "text\|ASCII\|UTF-8\|empty" | wc -l 2>/dev/null || echo "0")
if [ "$BINARY_FILES" -gt 0 ]; then
  echo "â„¹ï¸  INFO: $BINARY_FILES binary file(s) detected in commit"
  echo "   â€¢ Ensure binary files are necessary and appropriately sized"
  echo "   â€¢ Consider if they should be in .gitignore or Git LFS"
fi

# ============================================================================
# SUCCESS
# ============================================================================

echo ""
echo "âœ… ALL ENTERPRISE PRE-COMMIT CHECKS PASSED!"
echo "ğŸ‡ªğŸ‡¹ Meqenet.et maintains world-class FinTech security standards!"
echo ""
echo "ğŸ‰ Your code meets enterprise-grade quality requirements:"
echo "   â€¢ ğŸ” Security: Secret scanning âœ“ | Dependency audit âœ“ | Code security âœ“"
echo "   â€¢ ğŸ’° Financial: Logic validation âœ“ | Compliance checks âœ“ | Error handling âœ“"
echo "   â€¢ ğŸ“‹ Regulatory: NBE compliance âœ“ | GDPR validation âœ“ | Accessibility âœ“"
echo "   â€¢ ğŸ“Š Quality: Code complexity âœ“ | File size âœ“ | Commit standards âœ“"
echo "   â€¢ ğŸ›¡ï¸ Dependencies: Vulnerability scan âœ“ | License check âœ“ | Updates âœ“"
echo ""
echo "ğŸš€ Ready to contribute to Ethiopia's financial future!"
echo ""
echo "ğŸ’¡ Tips for continued excellence:"
echo "   â€¢ Keep commits focused and atomic"
echo "   â€¢ Write descriptive commit messages"
echo "   â€¢ Review security implications of changes"
echo "   â€¢ Test thoroughly before pushing"
echo ""
echo "ğŸ“ˆ Commit successful! Your contribution helps build a more secure financial ecosystem."