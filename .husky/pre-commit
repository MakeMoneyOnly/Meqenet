#!/bin/sh
# Meqenet.et Pre-Commit Hook
# Enterprise-Grade FinTech Security & Quality Gate
# Manual lint-staged implementation to bypass Windows bugs.

# Exit immediately if a command exits with a non-zero status.
set -e

echo "ğŸš€ Meqenet.et Enterprise Pre-Commit Quality Checks (Manual Mode)"
echo "=================================================="

# Set NODE_OPTIONS to prevent memory issues and enable better performance
export NODE_OPTIONS="--max-old-space-size=4096 --enable-source-maps=false"

echo "ğŸ“ Phase 0: Pre-commit validation started."

# ============================================================================
# PHASE 0.5: EARLY COMMIT MESSAGE VALIDATION (INTERACTIVE COMMITS)
# ============================================================================
echo "ğŸ“ Phase 0.5: Checking for interactive commit..."

# Check if this is an interactive commit (no -m flag used)
if [ -t 0 ] && [ -t 1 ]; then
  echo "ğŸ” Interactive commit detected - validating commit message format first..."

  # Prompt for commit message early
  echo "Please enter your commit message for validation:"
  echo "(Format: type(scope): description (TICKET-123))"
  read -p "Commit message: " EARLY_COMMIT_MSG

  if [ -z "$EARLY_COMMIT_MSG" ]; then
    echo "âŒ ERROR: Commit message cannot be empty"
    echo "ğŸ”’ COMMIT BLOCKED FOR ENTERPRISE COMPLIANCE"
    exit 1
  fi

  # IMMEDIATE VALIDATION - Check for Jira ticket first
  if ! echo "$EARLY_COMMIT_MSG" | grep -q -E '\((JIRA|TICKET|ISSUE|MEQ|BNPL|PAY|AUTH|SEC)-[0-9]+\)'; then
    echo "âŒ INVALID COMMIT MESSAGE FORMAT!"
    echo ""
    echo "ğŸš¨ MISSING JIRA TICKET REFERENCE"
    echo ""
    echo "ğŸ“‹ REQUIRED FORMAT:"
    echo "   type(scope): description (TICKET-123)"
    echo ""
    echo "âœ… Valid ticket formats:"
    echo "   (JIRA-123)    (TICKET-456)   (ISSUE-789)"
    echo "   (MEQ-101)     (BNPL-202)     (PAY-303)"
    echo "   (AUTH-404)    (SEC-505)"
    echo ""
    echo "ğŸ”’ COMMIT BLOCKED FOR ENTERPRISE COMPLIANCE"
    echo "ğŸ’¡ Pro tip: Use 'git commit -m \"your message\"' to avoid this prompt"
    exit 1
  fi

  echo "âœ… Early commit message validation passed!"
  echo "âš¡ Proceeding with full pre-commit checks..."
else
  echo "  â€¢ Non-interactive commit detected (using -m flag)"
  echo "  â€¢ Commit message will be validated in commit-msg hook"
fi

# ============================================================================
# PHASE 1: BASIC QUALITY GATES (Manual Implementation)
# ============================================================================

# 1. Find all relevant staged files
ALL_RELEVANT_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|jsx|ts|tsx|json|md|yml|yaml)$' || true)

if [ -z "$ALL_RELEVANT_FILES" ]; then
    echo "No relevant files to check. Skipping hooks."
    exit 0
fi

STAGED_COUNT=$(echo "$ALL_RELEVANT_FILES" | wc -l)
echo "ğŸ“Š Staged files to check: $STAGED_COUNT"

# ============================================================================
# PHASE 1: BASIC QUALITY GATES (Manual Implementation)
# ============================================================================
echo "ğŸ“ Phase 1: Running basic quality checks..."

# 1a. Filter for files that need linting
JS_TS_FILES=$(echo "$ALL_RELEVANT_FILES" | grep -E '\.(js|jsx|ts|tsx)$' || true)

# 1b. Run ESLint
if [ -n "$JS_TS_FILES" ]; then
  echo "  â€¢ Running ESLint on staged files..."
  pnpm lint:staged:eslint $JS_TS_FILES
  echo "  âœ… ESLint passed."
else
  echo "  â€¢ No JS/TS files to lint."
fi

# 1c. Run Prettier on all relevant files
echo "  â€¢ Running Prettier on staged files..."
# Handle file paths with spaces by processing each file individually
echo "$ALL_RELEVANT_FILES" | while IFS= read -r file; do
  if [ -n "$file" ]; then
    pnpm lint:staged:prettier "$file"
  fi
done
echo "  âœ… Prettier passed."

# 1d. Add back the changes made by the formatters
echo "  â€¢ Staging formatted files..."
echo "$ALL_RELEVANT_FILES" | while IFS= read -r file; do
  if [ -n "$file" ]; then
    git add "$file"
  fi
done

# ============================================================================
# PHASE 2: ENTERPRISE SECURITY VALIDATION (Comprehensive)
# ============================================================================
echo "ğŸ” Phase 2: Running comprehensive enterprise security validation..."

# Enterprise-grade security scanning
echo "  â€¢ Running enterprise security scan..."
if ! pnpm run security:enterprise-scan 2>&1; then
  echo "âŒ ENTERPRISE SECURITY SCAN FAILED!"
  exit 1
fi

# Supply chain security validation
echo "  â€¢ Running supply chain security checks..."
if ! pnpm run security:supply-chain 2>&1; then
  echo "âŒ SUPPLY CHAIN SECURITY CHECKS FAILED!"
  exit 1
fi

# ============================================================================
# PHASE 3: COMPLIANCE & REGULATORY CHECKS
# ============================================================================
echo "ğŸ“‹ Phase 3: Running compliance and regulatory checks..."

# Ethiopian FinTech compliance validation
echo "  â€¢ Running Ethiopian FinTech compliance checks..."
if ! pnpm run validate:ethiopian-compliance 2>&1; then
  echo "âŒ ETHIOPIAN COMPLIANCE CHECKS FAILED!"
  exit 1
fi

# Audit logging compliance
echo "  â€¢ Validating audit logging compliance..."
if ! pnpm run compliance:audit-logging 2>&1; then
  echo "âŒ AUDIT LOGGING COMPLIANCE FAILED!"
  exit 1
fi

# Transaction security validation
echo "  â€¢ Validating transaction security..."
if ! pnpm run compliance:transaction-security 2>&1; then
  echo "âŒ TRANSACTION SECURITY VALIDATION FAILED!"
  exit 1
fi

# ============================================================================
# PHASE 4: DEPENDENCY SECURITY AUDIT
# ============================================================================
echo "ğŸ” Phase 4: Running dependency security audit..."

# Comprehensive dependency audit
echo "  â€¢ Running comprehensive dependency audit..."
if ! pnpm run security:audit 2>&1; then
  echo "âŒ DEPENDENCY AUDIT FAILED!"
  exit 1
fi

# ============================================================================
# PHASE 5: CODE QUALITY METRICS
# ============================================================================
echo "ğŸ“Š Phase 5: Running code quality metrics..."

# TypeScript compilation check
echo "  â€¢ Running TypeScript compilation check..."
if ! pnpm run typecheck 2>&1; then
  echo "âŒ TYPESCRIPT COMPILATION FAILED!"
  exit 1
fi

# ============================================================================
# SUCCESS
# ============================================================================

echo ""
echo "ğŸ‰ ALL ENTERPRISE PRE-COMMIT CHECKS PASSED!"
echo "âœ… Code quality, security, compliance, and regulatory requirements met"
echo "ğŸ‡ªğŸ‡¹ Ready to contribute to Ethiopia's financial future!"
