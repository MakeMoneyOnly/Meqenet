# Meqenet.et Pre-Commit Hook
# Enterprise-Grade FinTech Security & Quality Gate

echo "ğŸš€ Meqenet.et Enterprise Pre-Commit Quality Checks"
echo "=================================================="

# Set NODE_OPTIONS to prevent memory issues
export NODE_OPTIONS="--max-old-space-size=4096"

# ============================================================================
# PHASE 1: BASIC QUALITY GATES
# ============================================================================

echo "ğŸ“ Phase 1: Running basic quality checks..."

# 1. Run lint-staged for staged files (formatting and linting)
echo "  â€¢ Code formatting and linting..."
pnpm exec lint-staged || {
  echo "âŒ Code quality checks failed"
  echo ""
  echo "ğŸ’¡ Troubleshooting tips:"
  echo "   â€¢ For ESLint errors, run: pnpm eslint --fix <file>"
  echo "   â€¢ For formatting issues, run: pnpm prettier --write <file>"
  echo "   â€¢ If memory issues persist, try staging fewer files"
  echo ""
  exit 1
}

# ============================================================================
# PHASE 2: FINTECH SECURITY VALIDATION
# ============================================================================

echo "ğŸ” Phase 2: FinTech security validation..."

# 2. Secret Scanning - Critical for FinTech
echo "  â€¢ Scanning for hardcoded secrets..."
if ! pnpm run security:secrets >/dev/null 2>&1; then
  echo "âŒ SECRET SCANNING FAILED!"
  echo ""
  echo "ğŸš¨ CRITICAL: Potential hardcoded secrets detected!"
  echo "   â€¢ API keys, passwords, or tokens may be exposed"
  echo "   â€¢ Review the output above and remove any sensitive data"
  echo "   â€¢ Use environment variables or secure vaults instead"
  echo ""
  exit 1
fi

# 3. Financial Logic Validation
echo "  â€¢ Validating financial logic integrity..."
STAGED_FILES=$(git diff --cached --name-only)

# Check for financial/payment related files
FINANCIAL_FILES=$(echo "$STAGED_FILES" | grep -E "(payment|credit|bnpl|financial|auth|loan|interest)" || true)
if [ -n "$FINANCIAL_FILES" ]; then
  echo "  â€¢ Financial code changes detected - validating critical patterns..."

  # Check for dangerous patterns in financial code (excluding legitimate Express middleware)
  if echo "$FINANCIAL_FILES" | xargs grep -l "eval(\|new Function\|setTimeout.*eval\|setInterval.*eval" 2>/dev/null; then
    echo "âŒ CRITICAL: Dangerous code patterns detected in financial logic!"
    echo "   â€¢ eval() or dynamic code execution found"
    echo "   â€¢ This poses severe security risks in financial systems"
    exit 1
  fi

  # Check for proper error handling in financial code
  if echo "$FINANCIAL_FILES" | xargs grep -L "try.*catch\|throw.*Error\|reject.*Error" 2>/dev/null | grep -v ".test." | grep -v ".spec."; then
    echo "âš ï¸  WARNING: Financial code without proper error handling detected"
    echo "   â€¢ Financial operations must have comprehensive error handling"
    echo "   â€¢ Consider adding try-catch blocks or proper error boundaries"
  fi
fi

# ============================================================================
# PHASE 3: COMPLIANCE & REGULATORY CHECKS
# ============================================================================

echo "ğŸ“‹ Phase 3: Compliance and regulatory checks..."

# 4. NBE Compliance Validation
echo "  â€¢ NBE (Ethiopian Banking) compliance validation..."
if [ -n "$FINANCIAL_FILES" ]; then
  # Check for required compliance patterns
  if ! echo "$FINANCIAL_FILES" | xargs grep -l "audit\|compliance\|NBE" 2>/dev/null; then
    echo "âš ï¸  WARNING: Financial changes without explicit compliance documentation"
    echo "   â€¢ NBE requires audit trails for all financial transactions"
    echo "   â€¢ Consider adding compliance comments or audit logging"
  fi
fi

# 5. GDPR Compliance Check
echo "  â€¢ GDPR compliance validation..."
PERSONAL_DATA_FILES=$(echo "$STAGED_FILES" | grep -E "(user|customer|personal|profile|auth)" || true)
if [ -n "$PERSONAL_DATA_FILES" ]; then
  if ! echo "$PERSONAL_DATA_FILES" | xargs grep -l "consent\|privacy\|gdpr\|data.*protection" 2>/dev/null; then
    echo "âš ï¸  WARNING: Personal data handling without GDPR compliance markers"
    echo "   â€¢ User data changes require GDPR compliance documentation"
    echo "   â€¢ Ensure proper consent mechanisms and data protection"
  fi
fi

# ============================================================================
# PHASE 4: CODE QUALITY METRICS
# ============================================================================

echo "ğŸ“Š Phase 4: Code quality metrics..."

# 6. Complexity Analysis
echo "  â€¢ Analyzing code complexity..."
COMPLEX_FILES=$(echo "$STAGED_FILES" | grep -E "\.(ts|tsx|js|jsx)$" | head -5)
if [ -n "$COMPLEX_FILES" ]; then
  # Check for overly complex functions (basic heuristic)
  COMPLEX_FUNCTIONS=$(echo "$COMPLEX_FILES" | xargs grep -n "function\|const.*=" | grep -A 50 -B 5 "{" | grep -c "{" | awk '$1 > 20 {print "Complex function detected"}' || true)
  if [ -n "$COMPLEX_FUNCTIONS" ]; then
    echo "âš ï¸  WARNING: Potential code complexity issues detected"
    echo "   â€¢ Functions with high cyclomatic complexity found"
    echo "   â€¢ Consider breaking down complex functions for maintainability"
  fi
fi

# ============================================================================
# PHASE 5: DEPENDENCY & SECURITY SCANNING
# ============================================================================

echo "ğŸ›¡ï¸  Phase 5: Dependency and security scanning..."

# 7. Dependency Vulnerability Check
echo "  â€¢ Checking for dependency vulnerabilities..."
if ! pnpm audit --audit-level moderate >/dev/null 2>&1; then
  echo "âš ï¸  WARNING: Dependency vulnerabilities detected"
  echo "   â€¢ Run 'pnpm audit' for detailed vulnerability information"
  echo "   â€¢ Consider updating vulnerable packages or applying patches"
fi

# ============================================================================
# PHASE 6: FINAL VALIDATION
# ============================================================================

echo "ğŸ¯ Phase 6: Final validation..."

# 8. Commit Message Validation
echo "  â€¢ Validating commit message format..."
COMMIT_MSG=$(git log -1 --pretty=%B)
if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|security)(\(.+\))?: .+"; then
  echo "âš ï¸  WARNING: Commit message doesn't follow conventional format"
  echo "   â€¢ Use: type(scope): description"
  echo "   â€¢ Types: feat, fix, docs, style, refactor, perf, test, chore, build, ci, security"
  echo "   â€¢ Example: feat(auth): add biometric authentication"
fi

# 9. File Size Validation
echo "  â€¢ Validating file sizes..."
LARGE_FILES=$(git diff --cached --name-only | xargs ls -lh 2>/dev/null | awk '$5 > 10485760 {print $9 ": " $5}' || true)
if [ -n "$LARGE_FILES" ]; then
  echo "âš ï¸  WARNING: Large files detected in commit"
  echo "$LARGE_FILES"
  echo "   â€¢ Files larger than 10MB may cause repository bloat"
  echo "   â€¢ Consider using Git LFS for large binary files"
fi

# ============================================================================
# SUCCESS
# ============================================================================

echo ""
echo "âœ… ALL ENTERPRISE PRE-COMMIT CHECKS PASSED!"
echo "ğŸ‡ªğŸ‡¹ Meqenet.et maintains world-class FinTech security standards!"
echo ""
echo "ğŸ‰ Your code meets enterprise-grade quality requirements:"
echo "   â€¢ ğŸ” Security vulnerabilities: CLEARED"
echo "   â€¢ ğŸ’° Financial logic: VALIDATED"
echo "   â€¢ ğŸ“‹ Compliance: VERIFIED"
echo "   â€¢ ğŸ“Š Code quality: APPROVED"
echo "   â€¢ ğŸ›¡ï¸ Dependencies: SECURE"
echo ""
echo "ğŸš€ Ready to contribute to Ethiopia's financial future!"