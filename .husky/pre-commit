#!/bin/sh
# Meqenet.et Pre-Commit Hook
# Enterprise-Grade FinTech Security & Quality Gate
# Manual lint-staged implementation to bypass Windows bugs.

echo "üöÄ Meqenet.et Enterprise Pre-Commit Quality Checks (Manual Mode)"
echo "=================================================="

# Exit immediately if a command exits with a non-zero status.
set -e

# Set NODE_OPTIONS to prevent memory issues and enable better performance
export NODE_OPTIONS="--max-old-space-size=4096 --enable-source-maps=false"

# 1. Find all relevant staged files
ALL_RELEVANT_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|jsx|ts|tsx|json|md|yml|yaml)$' || true)

if [ -z "$ALL_RELEVANT_FILES" ]; then
    echo "No relevant files to check. Skipping hooks."
    exit 0
fi

STAGED_COUNT=$(echo "$ALL_RELEVANT_FILES" | wc -l)
echo "üìä Staged files to check: $STAGED_COUNT"

# ============================================================================
# PHASE 1: BASIC QUALITY GATES (Manual Implementation)
# ============================================================================
echo "üìù Phase 1: Running basic quality checks..."

# 1a. Filter for files that need linting
JS_TS_FILES=$(echo "$ALL_RELEVANT_FILES" | grep -E '\.(js|jsx|ts|tsx)$' || true)

# 1b. Run ESLint
if [ -n "$JS_TS_FILES" ]; then
  echo "  ‚Ä¢ Running ESLint on staged files..."
  pnpm lint:staged:eslint $JS_TS_FILES
  echo "  ‚úÖ ESLint passed."
else
  echo "  ‚Ä¢ No JS/TS files to lint."
fi

# 1c. Run Prettier on all relevant files
echo "  ‚Ä¢ Running Prettier on staged files..."
pnpm lint:staged:prettier $ALL_RELEVANT_FILES
echo "  ‚úÖ Prettier passed."

# 1d. Add back the changes made by the formatters
echo "  ‚Ä¢ Staging formatted files..."
git add $ALL_RELEVANT_FILES

# ============================================================================
# PHASE 2: ENTERPRISE SECURITY VALIDATION (Abbreviated)
# ============================================================================
echo "üîê Phase 2: Running abbreviated security checks..."

# Secret Scanning - Critical for FinTech
echo "  ‚Ä¢ Scanning for hardcoded secrets..."
if ! pnpm run security:secrets 2>&1; then
  echo "‚ùå SECRET SCANNING FAILED!"
  exit 1
fi

# ============================================================================
# SUCCESS
# ============================================================================

echo ""
echo "‚úÖ ALL ENTERPRISE PRE-COMMIT CHECKS PASSED!"
