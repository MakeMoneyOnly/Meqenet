#!/usr/bin/env bash
# Husky v10 no longer requires sourcing the internal _/husky.sh shim. The following shebang is sufficient.

# Meqenet.et Pre-Push Hook
# Comprehensive FinTech Security & Quality Gate

echo "🚀 Meqenet.et Pre-Push Comprehensive Checks"
echo "============================================="

# Get the current branch name
branch=$(git rev-parse --abbrev-ref HEAD)
echo "🌿 Current branch: $branch"

# Determine if matching remote branch exists
if ! git ls-remote --exit-code --heads origin "$branch" >/dev/null 2>&1; then
  echo "ℹ️  Remote branch origin/$branch does not exist yet (first push). Skipping diff-based compliance checks."
  REMOTE_BRANCH_EXISTS=false
else
  REMOTE_BRANCH_EXISTS=true
fi

# 1. Run all tests
echo "🧪 Running all tests..."
# Capture test output in a temporary file to show on failure
# Use cross-platform temporary file creation
if command -v mktemp >/dev/null 2>&1; then
  TEST_OUTPUT_FILE=$(mktemp)
else
  # Fallback for systems without mktemp (like some Windows bash environments)
  TEST_OUTPUT_FILE="/tmp/pre-push-test-output.$$"
  touch "$TEST_OUTPUT_FILE"
fi

# Set CI environment variable properly for cross-platform compatibility
export CI=true
if ! pnpm run test 2>&1 | tee "$TEST_OUTPUT_FILE"; then
  echo "❌ Tests failed! Cannot push to remote."
  echo ""
  echo "📋 Test Output (last 50 lines):"
  echo "=================================="
  tail -n 50 "$TEST_OUTPUT_FILE" 2>/dev/null || cat "$TEST_OUTPUT_FILE"
  echo "=================================="
  echo ""
  echo "💡 To run tests manually and see full output: pnpm test"
  echo "🔒 PUSH BLOCKED FOR ENTERPRISE COMPLIANCE"
  echo "   • Fix all issues before pushing to remote repository"
  echo "   • Contact DevOps team for assistance: devops@meqenet.et"
  rm -f "$TEST_OUTPUT_FILE"
  exit 1
fi
rm -f "$TEST_OUTPUT_FILE"

# 2. Run Secret Scan
echo "🛡️  Running security scan for secrets..."
SECRET_PUSH_OUTPUT=$(pnpm run security:secrets 2>&1)
SECRET_PUSH_EXIT_CODE=$?

if [ $SECRET_PUSH_EXIT_CODE -ne 0 ]; then
    echo "❌ SECRET SCAN FAILED!"
    echo ""
    echo "📋 Detailed Security Scan Report:"
    echo "================================"
    echo "$SECRET_PUSH_OUTPUT"
    echo "================================"
    echo ""
    echo "🚨 CRITICAL SECURITY VIOLATION: Potential hardcoded secrets detected!"
    echo "   • IMMEDIATE ACTION REQUIRED: Review and remove all hardcoded credentials"
    echo "   • Contact Security Team: security@meqenet.et"
    echo ""
    echo "🔒 PUSH BLOCKED FOR ENTERPRISE COMPLIANCE"
    echo "   • Fix all security issues before pushing to remote repository"
    exit 1
fi

# 3. Check for critical vulnerabilities in dependencies
echo "🔍 Checking for dependency vulnerabilities..."
AUDIT_PUSH_OUTPUT=$(pnpm run security:audit 2>&1)
AUDIT_PUSH_EXIT_CODE=$?

if [ $AUDIT_PUSH_EXIT_CODE -ne 0 ]; then
  echo "❌ DEPENDENCY VULNERABILITIES FOUND!"
  echo ""
  echo "📋 Dependency Security Audit Report:"
  echo "==================================="
  echo "$AUDIT_PUSH_OUTPUT"
  echo "==================================="
  echo ""
  echo "🔧 Resolution Steps:"
  echo "   • Run 'pnpm audit fix' to attempt automatic fixes"
  echo "   • Run 'pnpm update' for compatible updates"
  echo "   • Contact Security Team for critical vulnerabilities: security@meqenet.et"
  echo ""
  echo "🔒 PUSH BLOCKED FOR ENTERPRISE COMPLIANCE"
  echo "   • All security vulnerabilities must be resolved before pushing"
  exit 1
fi

# 4. Build check
echo "🏗️  Running build check..."
# Use cross-platform temporary file creation
if command -v mktemp >/dev/null 2>&1; then
  BUILD_OUTPUT_FILE=$(mktemp)
else
  # Fallback for systems without mktemp (like some Windows bash environments)
  BUILD_OUTPUT_FILE="/tmp/pre-push-build-output.$$"
  touch "$BUILD_OUTPUT_FILE"
fi

if ! pnpm run build 2>&1 | tee "$BUILD_OUTPUT_FILE"; then
  echo "❌ BUILD FAILED!"
  echo ""
  echo "📋 Complete Build Error Report:"
  echo "==============================="
  cat "$BUILD_OUTPUT_FILE" 2>/dev/null || echo "No build output captured"
  echo "==============================="
  echo ""
  echo "🔧 Resolution Steps:"
  echo "   • Run 'pnpm run build' locally to see full error details"
  echo "   • Fix TypeScript compilation errors"
  echo "   • Check for missing dependencies"
  echo "   • Contact DevOps team: devops@meqenet.et"
  echo ""
  echo "🔒 PUSH BLOCKED FOR ENTERPRISE COMPLIANCE"
  echo "   • Build must succeed before pushing to remote repository"
  rm -f "$BUILD_OUTPUT_FILE"
  exit 1
fi
rm -f "$BUILD_OUTPUT_FILE"

# 5. Test Coverage Validation
echo "📊 Validating test coverage requirements..."
COVERAGE_OUTPUT=$(timeout 30 pnpm run test:coverage 2>&1)
COVERAGE_EXIT_CODE=$?

if [ $COVERAGE_EXIT_CODE -ne 0 ]; then
  echo "❌ TEST COVERAGE VALIDATION FAILED!"
  echo ""
  echo "📋 Test Coverage Report:"
  echo "======================="
  echo "$COVERAGE_OUTPUT"
  echo "======================="
  echo ""
  echo "🔧 Resolution Steps:"
  echo "   • Run 'pnpm run test:coverage' locally for detailed coverage report"
  echo "   • Add tests for uncovered code sections"
  echo "   • Financial/payment code must maintain 90%+ coverage"
  echo "   • Contact QA team for test coverage assistance: qa@meqenet.et"
  echo ""
  echo "🔒 PUSH BLOCKED FOR ENTERPRISE COMPLIANCE"
  echo "   • Minimum test coverage requirements must be met"
  exit 1
fi

# 6. Ethiopian FinTech specific checks
echo "🇪🇹 Running Ethiopian FinTech compliance checks..."

# Check for NBE compliance documentation
if [ "$branch" = "main" ] || [ "$branch" = "develop" ]; then
  echo "📋 Validating NBE compliance for protected branch..."
  if [ "$REMOTE_BRANCH_EXISTS" = true ]; then
    # Ensure financial logic has tests
    if git diff --name-only origin/$branch..HEAD | grep -q -E "^.+src/.+(payment|credit|bnpl|financial|auth).*\.(ts|js)$" > /dev/null; then
      echo "💰 Financial code changes detected - validating test coverage..."
      if ! git diff --name-only origin/$branch..HEAD | grep -E "(payment|credit|bnpl|financial|auth).*\.(test|spec)\.(ts|js)$" > /dev/null; then
        echo "❌ Financial code changes missing corresponding tests! Push rejected."
        exit 1
      fi
    fi
    # Check for Fayda ID integration changes
    if git diff --name-only origin/$branch..HEAD | xargs grep -l "fayda\|national.*id" 2>/dev/null; then
      echo "🆔 Fayda ID integration changes detected - validating security..."
      if ! git diff --name-only origin/$branch..HEAD | xargs grep -l "encrypt\|hash\|secure" 2>/dev/null; then
        echo "❌ Fayda ID changes missing encryption/security measures! Push rejected."
        exit 1
      fi
    fi
  fi
fi

# 6. Check for proper commit message format (if pushing to protected branches)
if [ "$branch" = "main" ] || [ "$branch" = "develop" ]; then
  echo "📝 Validating commit message format for protected branch..."
  last_commit_msg=$(git log -1 --pretty=%B)
  if ! echo "$last_commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|security)(\(.+\))?: .+"; then
    echo "⚠️  WARNING: Commit message doesn't follow conventional format!"
    echo "For protected branches, use: type(scope): description"
    echo "Types: feat, fix, docs, style, refactor, perf, test, chore, build, ci, security"
  fi
fi

# 7. Final dependency check
echo "📦 Final dependency validation..."
if ! pnpm install --no-frozen-lockfile --silent 2>&1; then
  echo "❌ Dependency installation failed!"
  echo "This indicates there are issues with package installation."
  echo "💡 Try running 'pnpm install' manually to see detailed error messages."
  echo "💡 Check if pnpm-lock.yaml is corrupted or if there are network issues."
  exit 1
fi

echo "✅ All pre-push checks passed!"
echo "🎉 Ready to push to Meqenet.et remote repository!"
echo "🇪🇹 Contributing to Ethiopia's financial future!"
