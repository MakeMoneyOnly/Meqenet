name: ğŸ” PWA Compliance Testing

on:
  push:
    branches: [main, develop]
    paths:
      - "frontend/apps/website/**"
      - "frontend/apps/website/public/manifest.json"
      - "frontend/apps/website/next.config.mjs"
  pull_request:
    branches: [main, develop]
    paths:
      - "frontend/apps/website/**"
      - "frontend/apps/website/public/manifest.json"
      - "frontend/apps/website/next.config.mjs"
  schedule:
    - cron: "0 6 * * MON" # Weekly on Monday
  workflow_dispatch:

env:
  NODE_VERSION: "22"
  WORKING_DIRECTORY: "./frontend/apps/website"

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  security-events: write

jobs:
  pwa-compliance-test:
    name: ğŸ§ª PWA Compliance Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: "https://registry.npmjs.org"

      - name: ğŸ“¦ Install pnpm
        run: |
          echo "ğŸ“¦ Installing pnpm..."
          # Use the official pnpm installation script
          curl -fsSL --connect-timeout 10 --max-time 30 https://get.pnpm.io/install.sh | sh -

          # Add pnpm to PATH for the current session
          export PNPM_HOME="$HOME/.local/share/pnpm"
          export PATH="$PNPM_HOME:$PATH"

          # Verify pnpm installation
          if command -v pnpm &> /dev/null; then
            echo "âœ… pnpm installed successfully"
            pnpm --version
          else
            echo "âŒ pnpm installation failed"
            exit 1
          fi

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend
          pnpm config set registry https://registry.npmjs.org/
          pnpm install --no-frozen-lockfile --ignore-scripts

      - name: ğŸ” Run PWA Compliance Tests
        run: |
          echo "ğŸ§ª Running PWA compliance tests..."
          node scripts/test-pwa-compliance.js
        continue-on-error: true

      - name: ğŸ“Š Upload PWA Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pwa-test-report
          path: |
            pwa-test-report.json
            PWA_TEST_REPORT.md

      - name: ğŸ’¬ Comment PWA Results on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          script: |
            const fs = require('fs');

            // Read the PWA test report
            let reportContent = 'PWA compliance test results not available';
            try {
              if (fs.existsSync('PWA_TEST_REPORT.md')) {
                reportContent = fs.readFileSync('PWA_TEST_REPORT.md', 'utf8');
              }
            } catch (error) {
              console.log('Could not read PWA test report:', error.message);
            }

            // Create or update comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes('ğŸ” PWA Compliance Test Report')
            );

            const body = '## ğŸ” PWA Compliance Test Report\n\n' + reportContent + '\n\n---\n*This comment was automatically generated by the PWA Compliance Testing workflow.*'

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  lighthouse-pwa-audit:
    name: ğŸŒŠ Lighthouse PWA Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pwa-compliance-test]

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install pnpm (with retry logic)
        run: |
          echo "ğŸ“¦ Installing pnpm with retry logic..."
          for i in {1..3}; do
          # Use the official pnpm installation script
          curl -fsSL --connect-timeout 10 --max-time 30 https://get.pnpm.io/install.sh | sh -

          # Add pnpm to PATH for the current session
          export PNPM_HOME="$HOME/.local/share/pnpm"
          export PATH="$PNPM_HOME:$PATH"

          # Verify pnpm installation
          if command -v pnpm &> /dev/null; then
              echo "âœ… pnpm installed successfully on attempt $i"
              break
            else
              echo "âŒ pnpm installation failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "ğŸ”„ Falling back to direct download..."
                curl -fsSL --connect-timeout 10 --max-time 30 https://get.pnpm.io/install.sh | PNPM_VERSION=${{ env.PNPM_VERSION }} sh -
                break
              fi
              sleep 2
            fi
          done

          # Verify pnpm installation
          pnpm --version

      - name: ğŸ“š Install Dependencies
        run: |
          cd frontend
          export PNPM_HOME="$HOME/.local/share/pnpm"
          export PATH="$PNPM_HOME:$PATH"

          # Clear any existing Metro cache that might cause SHA-1 issues
          echo "ğŸ§¹ Clearing Metro bundler cache..."
          rm -rf apps/app/.metro || true
          rm -rf node_modules/.cache || true
          rm -rf apps/app/node_modules/.cache || true

          # Install dependencies with retry logic
          echo "ğŸ“¦ Installing dependencies..."
          for attempt in {1..3}; do
            if pnpm install --no-frozen-lockfile --ignore-scripts; then
              echo "âœ… Dependencies installed successfully"
              break
            else
              echo "âŒ Installation failed on attempt $attempt"
              if [ $attempt -eq 3 ]; then
                echo "ğŸ’¥ CRITICAL: All dependency installation attempts failed"
                exit 1
              fi
              echo "â³ Waiting before retry..."
              sleep 5
            fi
          done

          # Verify pnpm installation
          pnpm --version

      - name: ğŸ—ï¸ Build Website
        run: |
          cd frontend/apps/website
          npm run build

      - name: ğŸš€ Start Development Server
        run: |
          cd frontend/apps/website
          npm start &
          sleep 10

      - name: ğŸŒŠ Run Lighthouse PWA Audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: http://localhost:3000
          configPath: .github/lighthouse/pwa-config.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: ğŸ“Š Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: |
            .lighthouseci/
            lighthouse-results.json

  pwa-manifest-validation:
    name: ğŸ“‹ PWA Manifest Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ” Validate PWA Manifest
        run: |
          echo "ğŸ“‹ Validating PWA manifest..."

          MANIFEST_PATH="frontend/apps/website/public/manifest.json"

          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "âŒ PWA manifest not found at $MANIFEST_PATH"
            exit 1
          fi

          # Validate JSON syntax
          if ! jq empty "$MANIFEST_PATH" 2>/dev/null; then
            echo "âŒ Invalid JSON in PWA manifest"
            exit 1
          fi

          echo "âœ… PWA manifest is valid JSON"

          # Check required fields
          REQUIRED_FIELDS=("name" "short_name" "start_url" "display" "icons")
          for field in "${REQUIRED_FIELDS[@]}"; do
            if ! jq -e ".${field}" "$MANIFEST_PATH" >/dev/null; then
              echo "âŒ Missing required field: $field"
              exit 1
            fi
          done

          echo "âœ… All required manifest fields are present"

          # Validate icon sizes
          ICONS=$(jq -r '.icons[]?.sizes // empty' "$MANIFEST_PATH")
          if echo "$ICONS" | grep -q "192x192" && echo "$ICONS" | grep -q "512x512"; then
            echo "âœ… Required icon sizes (192x192, 512x512) are present"
          else
            echo "âš ï¸  Missing recommended icon sizes (192x192, 512x512)"
          fi

          # Validate display mode
          DISPLAY=$(jq -r '.display' "$MANIFEST_PATH")
          if [ "$DISPLAY" = "standalone" ]; then
            echo "âœ… Display mode is set to 'standalone' (recommended)"
          else
            echo "âš ï¸  Display mode is '$DISPLAY', consider 'standalone' for better PWA experience"
          fi

          echo "âœ… PWA manifest validation completed successfully"

  pwa-service-worker-check:
    name: ğŸ”§ Service Worker Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ”§ Check Service Worker Files
        run: |
          echo "ğŸ”§ Checking service worker configuration..."

          PUBLIC_DIR="frontend/apps/website/public"
          NEXT_CONFIG="frontend/apps/website/next.config.mjs"

          # Check if next-pwa is configured
          if grep -q "next-pwa\|withPWA" "$NEXT_CONFIG"; then
            echo "âœ… Next.js PWA plugin is configured"
          else
            echo "âŒ Next.js PWA plugin not found in configuration"
            exit 1
          fi

          # Check if service worker destination is configured
          if grep -q "dest.*public" "$NEXT_CONFIG"; then
            echo "âœ… Service worker destination is configured correctly"
          else
            echo "âš ï¸  Service worker destination may not be configured correctly"
          fi

          # Check for existing service worker files (if any)
          SW_FILES=$(find "$PUBLIC_DIR" -name "*sw.js" -o -name "workbox-*" 2>/dev/null | wc -l)
          if [ "$SW_FILES" -gt 0 ]; then
            echo "âœ… Found $SW_FILES service worker related files"
          else
            echo "â„¹ï¸  No service worker files found (this is normal before build)"
          fi

          echo "âœ… Service worker validation completed"

  pwa-compliance-summary:
    name: ğŸ“Š PWA Compliance Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      [
        pwa-compliance-test,
        lighthouse-pwa-audit,
        pwa-manifest-validation,
        pwa-service-worker-check,
      ]
    if: always()

    steps:
      - name: ğŸ“¥ Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: ./reports

      - name: ğŸ“Š Generate Compliance Summary
        run: |
          echo "## ğŸ” PWA Compliance Testing Summary" > pwa-compliance-summary.md
          echo "" >> pwa-compliance-summary.md
          echo "**Generated:** $(date)" >> pwa-compliance-summary.md
          echo "**Run ID:** $GITHUB_RUN_ID" >> pwa-compliance-summary.md
          echo "" >> pwa-compliance-summary.md

          # Check PWA test results
          if [ -f "reports/pwa-test-report/pwa-test-report.json" ]; then
            SCORE=$(jq -r '.summary.overallScore' reports/pwa-test-report/pwa-test-report.json 2>/dev/null || echo "N/A")
            ISSUES=$(jq -r '.summary.totalIssues' reports/pwa-test-report/pwa-test-report.json 2>/dev/null || echo "N/A")
            WARNINGS=$(jq -r '.summary.totalWarnings' reports/pwa-test-report/pwa-test-report.json 2>/dev/null || echo "N/A")

            echo "### ğŸ§ª PWA Compliance Test Results" >> pwa-compliance-summary.md
            echo "- **Overall Score:** $SCORE/100" >> pwa-compliance-summary.md
            echo "- **Critical Issues:** $ISSUES" >> pwa-compliance-summary.md
            echo "- **Warnings:** $WARNINGS" >> pwa-compliance-summary.md

            if [ "$SCORE" != "N/A" ] && [ "$SCORE" -ge 80 ]; then
              echo "- **Status:** âœ… PASSED" >> pwa-compliance-summary.md
            elif [ "$SCORE" != "N/A" ] && [ "$SCORE" -ge 60 ]; then
              echo "- **Status:** âš ï¸  NEEDS IMPROVEMENT" >> pwa-compliance-summary.md
            else
              echo "- **Status:** âŒ FAILED" >> pwa-compliance-summary.md
            fi
          else
            echo "### ğŸ§ª PWA Compliance Test Results" >> pwa-compliance-summary.md
            echo "- **Status:** âŒ Test report not found" >> pwa-compliance-summary.md
          fi

          echo "" >> pwa-compliance-summary.md

          # Check Lighthouse results
          if [ -f "reports/lighthouse-report/lighthouse-results.json" ]; then
            PWA_SCORE=$(jq -r '.categories.pwa.score * 100' reports/lighthouse-report/lighthouse-results.json 2>/dev/null || echo "N/A")
            PERFORMANCE_SCORE=$(jq -r '.categories.performance.score * 100' reports/lighthouse-report/lighthouse-results.json 2>/dev/null || echo "N/A")

            echo "### ğŸŒŠ Lighthouse Audit Results" >> pwa-compliance-summary.md
            echo "- **PWA Score:** $PWA_SCORE/100" >> pwa-compliance-summary.md
            echo "- **Performance Score:** $PERFORMANCE_SCORE/100" >> pwa-compliance-summary.md
          else
            echo "### ğŸŒŠ Lighthouse Audit Results" >> pwa-compliance-summary.md
            echo "- **Status:** Lighthouse report not available" >> pwa-compliance-summary.md
          fi

          echo "" >> pwa-compliance-summary.md
          echo "### ğŸ“‹ Validation Results" >> pwa-compliance-summary.md
          echo "- âœ… **Manifest Validation:** Completed" >> pwa-compliance-summary.md
          echo "- âœ… **Service Worker Check:** Completed" >> pwa-compliance-summary.md

          echo "" >> pwa-compliance-summary.md
          echo "### ğŸ¯ Recommendations" >> pwa-compliance-summary.md

          # Add recommendations based on scores
          if [ "$SCORE" != "N/A" ] && [ "$SCORE" -lt 80 ]; then
            echo "- Review and fix critical PWA compliance issues" >> pwa-compliance-summary.md
            echo "- Ensure proper service worker configuration" >> pwa-compliance-summary.md
            echo "- Verify PWA manifest completeness" >> pwa-compliance-summary.md
          fi

          if [ "$PWA_SCORE" != "N/A" ] && [ "$PWA_SCORE" -lt 80 ]; then
            echo "- Improve PWA-specific performance metrics" >> pwa-compliance-summary.md
            echo "- Optimize service worker caching strategies" >> pwa-compliance-summary.md
            echo "- Enhance offline capabilities" >> pwa-compliance-summary.md
          fi

          echo "- Regularly run PWA compliance tests" >> pwa-compliance-summary.md
          echo "- Keep PWA dependencies updated" >> pwa-compliance-summary.md

          echo "" >> pwa-compliance-summary.md
          echo "---" >> pwa-compliance-summary.md
          echo "*Generated by Meqenet PWA Compliance Testing Workflow*" >> pwa-compliance-summary.md

      - name: ğŸ“¤ Upload Summary Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pwa-compliance-summary
          path: |
            pwa-compliance-summary.md

      - name: ğŸ‰ PWA Compliance Testing Complete
        run: |
          echo "ğŸ‰ PWA compliance testing workflow completed!"
          echo "ğŸ“Š Check the uploaded artifacts for detailed reports"
          echo "ğŸ” Summary report: pwa-compliance-summary.md"
