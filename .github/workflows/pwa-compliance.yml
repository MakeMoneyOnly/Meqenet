name: 🔍 PWA Compliance Testing

on:
  push:
    branches: [main, develop]
    paths:
      - "frontend/apps/website/**"
      - "frontend/apps/website/public/manifest.json"
      - "frontend/apps/website/next.config.mjs"
  pull_request:
    branches: [main, develop]
    paths:
      - "frontend/apps/website/**"
      - "frontend/apps/website/public/manifest.json"
      - "frontend/apps/website/next.config.mjs"
  schedule:
    - cron: "0 6 * * MON" # Weekly on Monday
  workflow_dispatch:

env:
  NODE_VERSION: "22"
  WORKING_DIRECTORY: "./frontend/apps/website"

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  security-events: write

jobs:
  pwa-compliance-test:
    name: 🧪 PWA Compliance Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v5

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: "https://registry.npmjs.org"

      - name: 🔧 Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.4.1
          run_install: false

      - name: 📦 Install Dependencies
        run: |
          cd frontend
          pnpm config set registry https://registry.npmjs.org/
          pnpm install --no-frozen-lockfile --ignore-scripts
          corepack enable

      - name: 🔍 Run PWA Compliance Tests
        run: |
          echo "🧪 Running PWA compliance tests..."
          node scripts/test-pwa-compliance.js
        continue-on-error: true

      - name: 📊 Upload PWA Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pwa-test-report
          path: |
            pwa-test-report.json
            PWA_TEST_REPORT.md

      - name: 💬 Comment PWA Results on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          script: |
            const fs = require('fs');

            // Read the PWA test report
            let reportContent = 'PWA compliance test results not available';
            try {
              if (fs.existsSync('PWA_TEST_REPORT.md')) {
                reportContent = fs.readFileSync('PWA_TEST_REPORT.md', 'utf8');
              }
            } catch (error) {
              console.log('Could not read PWA test report:', error.message);
            }

            // Create or update comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes('🔍 PWA Compliance Test Report')
            );

            const body = '## 🔍 PWA Compliance Test Report\n\n' + reportContent + '\n\n---\n*This comment was automatically generated by the PWA Compliance Testing workflow.*'

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  lighthouse-pwa-audit:
    name: 🌊 Lighthouse PWA Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pwa-compliance-test]

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v5

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 🔧 Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.4.1

      - name: 📦 Install Dependencies
        run: |
          cd frontend
          pnpm install --no-frozen-lockfile
          corepack enable

      - name: 🏗️ Build Website
        run: |
          cd frontend/apps/website
          npm run build

      - name: 🚀 Start Development Server
        run: |
          cd frontend/apps/website
          npm start &
          sleep 10

      - name: 🌊 Run Lighthouse PWA Audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: http://localhost:3000
          configPath: .github/lighthouse/pwa-config.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: 📊 Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: |
            .lighthouseci/
            lighthouse-results.json

  pwa-manifest-validation:
    name: 📋 PWA Manifest Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v5

      - name: 🔍 Validate PWA Manifest
        run: |
          echo "📋 Validating PWA manifest..."

          MANIFEST_PATH="frontend/apps/website/public/manifest.json"

          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "❌ PWA manifest not found at $MANIFEST_PATH"
            exit 1
          fi

          # Validate JSON syntax
          if ! jq empty "$MANIFEST_PATH" 2>/dev/null; then
            echo "❌ Invalid JSON in PWA manifest"
            exit 1
          fi

          echo "✅ PWA manifest is valid JSON"

          # Check required fields
          REQUIRED_FIELDS=("name" "short_name" "start_url" "display" "icons")
          for field in "${REQUIRED_FIELDS[@]}"; do
            if ! jq -e ".${field}" "$MANIFEST_PATH" >/dev/null; then
              echo "❌ Missing required field: $field"
              exit 1
            fi
          done

          echo "✅ All required manifest fields are present"

          # Validate icon sizes
          ICONS=$(jq -r '.icons[]?.sizes // empty' "$MANIFEST_PATH")
          if echo "$ICONS" | grep -q "192x192" && echo "$ICONS" | grep -q "512x512"; then
            echo "✅ Required icon sizes (192x192, 512x512) are present"
          else
            echo "⚠️  Missing recommended icon sizes (192x192, 512x512)"
          fi

          # Validate display mode
          DISPLAY=$(jq -r '.display' "$MANIFEST_PATH")
          if [ "$DISPLAY" = "standalone" ]; then
            echo "✅ Display mode is set to 'standalone' (recommended)"
          else
            echo "⚠️  Display mode is '$DISPLAY', consider 'standalone' for better PWA experience"
          fi

          echo "✅ PWA manifest validation completed successfully"

  pwa-service-worker-check:
    name: 🔧 Service Worker Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v5

      - name: 🔧 Check Service Worker Files
        run: |
          echo "🔧 Checking service worker configuration..."

          PUBLIC_DIR="frontend/apps/website/public"
          NEXT_CONFIG="frontend/apps/website/next.config.mjs"

          # Check if next-pwa is configured
          if grep -q "next-pwa\|withPWA" "$NEXT_CONFIG"; then
            echo "✅ Next.js PWA plugin is configured"
          else
            echo "❌ Next.js PWA plugin not found in configuration"
            exit 1
          fi

          # Check if service worker destination is configured
          if grep -q "dest.*public" "$NEXT_CONFIG"; then
            echo "✅ Service worker destination is configured correctly"
          else
            echo "⚠️  Service worker destination may not be configured correctly"
          fi

          # Check for existing service worker files (if any)
          SW_FILES=$(find "$PUBLIC_DIR" -name "*sw.js" -o -name "workbox-*" 2>/dev/null | wc -l)
          if [ "$SW_FILES" -gt 0 ]; then
            echo "✅ Found $SW_FILES service worker related files"
          else
            echo "ℹ️  No service worker files found (this is normal before build)"
          fi

          echo "✅ Service worker validation completed"

  pwa-compliance-summary:
    name: 📊 PWA Compliance Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      [
        pwa-compliance-test,
        lighthouse-pwa-audit,
        pwa-manifest-validation,
        pwa-service-worker-check,
      ]
    if: always()

    steps:
      - name: 📥 Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: ./reports

      - name: 📊 Generate Compliance Summary
        run: |
          echo "## 🔍 PWA Compliance Testing Summary" > pwa-compliance-summary.md
          echo "" >> pwa-compliance-summary.md
          echo "**Generated:** $(date)" >> pwa-compliance-summary.md
          echo "**Run ID:** $GITHUB_RUN_ID" >> pwa-compliance-summary.md
          echo "" >> pwa-compliance-summary.md

          # Check PWA test results
          if [ -f "reports/pwa-test-report/pwa-test-report.json" ]; then
            SCORE=$(jq -r '.summary.overallScore' reports/pwa-test-report/pwa-test-report.json 2>/dev/null || echo "N/A")
            ISSUES=$(jq -r '.summary.totalIssues' reports/pwa-test-report/pwa-test-report.json 2>/dev/null || echo "N/A")
            WARNINGS=$(jq -r '.summary.totalWarnings' reports/pwa-test-report/pwa-test-report.json 2>/dev/null || echo "N/A")

            echo "### 🧪 PWA Compliance Test Results" >> pwa-compliance-summary.md
            echo "- **Overall Score:** $SCORE/100" >> pwa-compliance-summary.md
            echo "- **Critical Issues:** $ISSUES" >> pwa-compliance-summary.md
            echo "- **Warnings:** $WARNINGS" >> pwa-compliance-summary.md

            if [ "$SCORE" != "N/A" ] && [ "$SCORE" -ge 80 ]; then
              echo "- **Status:** ✅ PASSED" >> pwa-compliance-summary.md
            elif [ "$SCORE" != "N/A" ] && [ "$SCORE" -ge 60 ]; then
              echo "- **Status:** ⚠️  NEEDS IMPROVEMENT" >> pwa-compliance-summary.md
            else
              echo "- **Status:** ❌ FAILED" >> pwa-compliance-summary.md
            fi
          else
            echo "### 🧪 PWA Compliance Test Results" >> pwa-compliance-summary.md
            echo "- **Status:** ❌ Test report not found" >> pwa-compliance-summary.md
          fi

          echo "" >> pwa-compliance-summary.md

          # Check Lighthouse results
          if [ -f "reports/lighthouse-report/lighthouse-results.json" ]; then
            PWA_SCORE=$(jq -r '.categories.pwa.score * 100' reports/lighthouse-report/lighthouse-results.json 2>/dev/null || echo "N/A")
            PERFORMANCE_SCORE=$(jq -r '.categories.performance.score * 100' reports/lighthouse-report/lighthouse-results.json 2>/dev/null || echo "N/A")

            echo "### 🌊 Lighthouse Audit Results" >> pwa-compliance-summary.md
            echo "- **PWA Score:** $PWA_SCORE/100" >> pwa-compliance-summary.md
            echo "- **Performance Score:** $PERFORMANCE_SCORE/100" >> pwa-compliance-summary.md
          else
            echo "### 🌊 Lighthouse Audit Results" >> pwa-compliance-summary.md
            echo "- **Status:** Lighthouse report not available" >> pwa-compliance-summary.md
          fi

          echo "" >> pwa-compliance-summary.md
          echo "### 📋 Validation Results" >> pwa-compliance-summary.md
          echo "- ✅ **Manifest Validation:** Completed" >> pwa-compliance-summary.md
          echo "- ✅ **Service Worker Check:** Completed" >> pwa-compliance-summary.md

          echo "" >> pwa-compliance-summary.md
          echo "### 🎯 Recommendations" >> pwa-compliance-summary.md

          # Add recommendations based on scores
          if [ "$SCORE" != "N/A" ] && [ "$SCORE" -lt 80 ]; then
            echo "- Review and fix critical PWA compliance issues" >> pwa-compliance-summary.md
            echo "- Ensure proper service worker configuration" >> pwa-compliance-summary.md
            echo "- Verify PWA manifest completeness" >> pwa-compliance-summary.md
          fi

          if [ "$PWA_SCORE" != "N/A" ] && [ "$PWA_SCORE" -lt 80 ]; then
            echo "- Improve PWA-specific performance metrics" >> pwa-compliance-summary.md
            echo "- Optimize service worker caching strategies" >> pwa-compliance-summary.md
            echo "- Enhance offline capabilities" >> pwa-compliance-summary.md
          fi

          echo "- Regularly run PWA compliance tests" >> pwa-compliance-summary.md
          echo "- Keep PWA dependencies updated" >> pwa-compliance-summary.md

          echo "" >> pwa-compliance-summary.md
          echo "---" >> pwa-compliance-summary.md
          echo "*Generated by Meqenet PWA Compliance Testing Workflow*" >> pwa-compliance-summary.md

      - name: 📤 Upload Summary Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pwa-compliance-summary
          path: |
            pwa-compliance-summary.md

      - name: 🎉 PWA Compliance Testing Complete
        run: |
          echo "🎉 PWA compliance testing workflow completed!"
          echo "📊 Check the uploaded artifacts for detailed reports"
          echo "🔍 Summary report: pwa-compliance-summary.md"
