name: Infrastructure as Code Security Scan

on:
  push:
    branches: [main, develop]
    paths:
      - "infrastructure/**"
      - ".github/workflows/iac-security-scan.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "infrastructure/**"
  workflow_dispatch:

jobs:
  tfsec:
    name: "tfsec Security Scan"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-sarif-action@v1.0.3
        with:
          sarif_file: tfsec-results.sarif

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: tfsec-results.sarif

  checkov:
    name: "Checkov Security Scan"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        continue-on-error: true
        with:
          directory: infrastructure/
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif
          quiet: true
          soft_fail: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif

  terrascan:
    name: "Terrascan Security Scan"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Terrascan
        id: terrascan
        uses: accurics/terrascan-action@main
        with:
          iac_type: "terraform"
          iac_version: "v14"
          policy_type: "aws"
          only_warn: true
          sarif_upload: true
          working_directory: infrastructure/

  kics:
    name: "KICS Security Scan"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run KICS
        uses: Checkmarx/kics-github-action@v2.1.13
        with:
          path: "infrastructure"
          platform_type: terraform
          output_formats: "sarif,json"
          output_path: "kics-results"
          ignore_on_exit: "info"

      - name: Check KICS output files
        run: |
          echo "ðŸ“ Listing KICS output directory..."
          ls -la kics-results/ 2>/dev/null || echo "kics-results directory not found"
          echo "ðŸ“„ Searching for SARIF files..."
          find . -name "*.sarif" -type f 2>/dev/null || echo "No SARIF files found"

      - name: Upload KICS SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: kics-results/results.sarif

  summary:
    name: "Security Scan Summary"
    runs-on: ubuntu-latest
    needs: [tfsec, checkov, terrascan, kics]
    if: always()
    steps:
      - name: Generate Security Report
        run: |
          echo "# Infrastructure as Code Security Scan Results" > security-report.md
          echo "" >> security-report.md
          echo "## Scan Status Summary" >> security-report.md
          echo "" >> security-report.md

          # tfsec status
          if [ "${{ needs.tfsec.result }}" == "success" ]; then
            echo "âœ… **tfsec**: Passed" >> security-report.md
          else
            echo "âŒ **tfsec**: Failed or had issues" >> security-report.md
          fi

          # checkov status
          if [ "${{ needs.checkov.result }}" == "success" ]; then
            echo "âœ… **Checkov**: Passed" >> security-report.md
          else
            echo "âŒ **Checkov**: Failed or had issues" >> security-report.md
          fi

          # terrascan status
          if [ "${{ needs.terrascan.result }}" == "success" ]; then
            echo "âœ… **Terrascan**: Passed" >> security-report.md
          else
            echo "âŒ **Terrascan**: Failed or had issues" >> security-report.md
          fi

          # kics status
          if [ "${{ needs.kics.result }}" == "success" ]; then
            echo "âœ… **KICS**: Passed" >> security-report.md
          else
            echo "âŒ **KICS**: Failed or had issues" >> security-report.md
          fi

          echo "" >> security-report.md
          echo "## Security Best Practices" >> security-report.md
          echo "" >> security-report.md
          echo "- âœ… Infrastructure encryption enabled" >> security-report.md
          echo "- âœ… VPC flow logging configured" >> security-report.md
          echo "- âœ… Security groups with least privilege" >> security-report.md
          echo "- âœ… Secrets management with KMS" >> security-report.md
          echo "- âœ… Database backup and deletion protection" >> security-report.md
          echo "" >> security-report.md
          echo "*Generated on: $(date)*" >> security-report.md

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: iac-security-report
          path: security-report.md
